// Generated by CoffeeScript 1.6.3
(function() {
  var Gcalendar, clearInstance, crypto, instances, loadInstance, logger,
    __slice = [].slice;

  crypto = require('crypto');

  Gcalendar = require('./gcalendar');

  logger = require('graceful-logger');

  instances = {};

  clearInstance = function() {
    var instance, k;
    for (k in instances) {
      instance = instances[k];
      if (new Date - instance.started > 60000) {
        delete instances[k];
      }
    }
    return true;
  };

  loadInstance = function(instanceId, callback) {
    if (Math.round(Math.random() * 200) === 100) {
      clearInstance();
    }
    if (!instances[instanceId]) {
      logger.warn("error NOINSTANCE: " + instanceId);
      return callback(new Error('NOINSTANCE'));
    }
    return callback(null, instances[instanceId]);
  };

  exports.init = function(options, callback) {
    var gc, instanceId;
    if (callback == null) {
      callback = function() {};
    }
    instanceId = crypto.createHash('sha1').update(JSON.stringify(options)).digest('hex');
    logger.info("instance id: " + instanceId);
    gc = new Gcalendar(options);
    gc.started = new Date;
    instances[instanceId] = gc;
    return callback(null, instanceId);
  };

  exports.api = function() {
    var args, instanceId, query;
    instanceId = arguments[0], query = arguments[1], args = 3 <= arguments.length ? __slice.call(arguments, 2) : [];
    logger.info("call api: " + instanceId);
    return loadInstance(instanceId, function(err, instance) {
      if (err != null) {
        return callback(err);
      }
      return instance.api(query).apply(instance, args);
    });
  };

  exports.generateAuthUrl = function(instanceId, callback) {
    if (callback == null) {
      callback = function() {};
    }
    logger.info("call generateAuthUrl: " + instanceId);
    return loadInstance(instanceId, function(err, instance) {
      if (err != null) {
        return callback(err);
      }
      return callback(null, instance.generateAuthUrl());
    });
  };

  ['getToken', 'refreshToken'].forEach(function(method) {
    return exports[method] = function() {
      var args, instanceId;
      instanceId = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      logger.info("call " + method + ": " + instanceId);
      return loadInstance(instanceId, function(err, instance) {
        return instance[method].apply(instance, args);
      });
    };
  });

}).call(this);
